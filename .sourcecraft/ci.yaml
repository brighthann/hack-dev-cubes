on:
  push:
    - workflows: demo-cubes

workflows:
  demo-cubes:
    tasks:
      - name: build-and-test
        cubes:
          - name: build-all-cubes
            image: docker:latest
            script:
              - |
                echo "==================================="
                echo "Building Hack-Dev-Cubes for Demo"
                echo "==================================="
                
                # Build Telegram cube if it exists
                if [ -f "telegramCube/Dockerfile" ]; then
                  echo "Building Telegram cube..."
                  docker build -t telegramCube:demo ./telegramCube
                  echo "Telegram cube built"
                else
                  echo "Skipping Telegram cube (not ready)"
                fi
                
                # Build Yandex Messenger cube
                echo "Building Yandex Messenger cube..."
                docker build -t yandex-messenger:demo ./yandex-messenger-cube
                echo "Yandex Messenger cube built"
                
                # Build Git Mirror cube
                echo "Building Git Mirror cube..."
                docker build -t git-mirror:demo ./git-mirror-cube
                echo "Git Mirror cube built"
                
                echo "==================================="
                echo "All cubes built successfully!"
                echo "==================================="
                
          - name: test-yandex-messenger
            image: docker:latest
            script:
              - |
                echo "Testing Yandex Messenger cube..."
                docker run --rm \
                  -e CHAT_ID=test-chat \
                  -e MESSAGE="Hackathon Demo Test" \
                  -e BUILD_STATUS=success \
                  yandex-messenger:demo
                  
          - name: test-git-mirror
            image: docker:latest
            script:
              - |
                echo "Testing Git Mirror cube..."
                docker run --rm \
                  -e SOURCE_REPO=https://github.com/test/source \
                  -e TARGET_REPO=https://github.com/test/target \
                  -e BRANCH=main \
                  git-mirror:demo